<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ECOBANK</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üåø</text></svg>">
    <link rel="stylesheet" href="css/style.css">
    <style>
        /* CSS ‡∏Å‡∏≤‡∏£‡πå‡∏î (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏õ‡πä‡∏∞) */
        .schedule-card {
            background: #1e2329; border: 1px solid #2b3139; border-radius: 12px; padding: 20px;
            margin-bottom: 15px; transition: all 0.3s ease; cursor: pointer;
            display: flex; flex-direction: column; position: relative; overflow: hidden;
        }
        .schedule-card:hover { border-color: var(--primary-color); transform: translateY(-5px); box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .card-header-row { display: flex; align-items: center; width: 100%; z-index: 2; }
        .date-box { background: #2b3139; padding: 10px 15px; border-radius: 8px; text-align: center; margin-right: 20px; min-width: 60px; border: 1px solid #363c45; }
        .date-day { font-size: 24px; font-weight: bold; color: #fff; line-height: 1; }
        .date-month { font-size: 12px; color: #848e9c; margin-top: 5px; }
        .tag { font-size: 10px; padding: 2px 8px; border-radius: 4px; background: rgba(178, 255, 89, 0.1); color: var(--primary-color); margin-right: 5px; display: inline-block; margin-top: 5px; }
        
        .card-details {
            max-height: 0; opacity: 0; overflow: hidden; transition: all 0.5s cubic-bezier(0.25, 1, 0.5, 1);
            margin-top: 0; background: #15181d; border-radius: 8px;
        }
        .schedule-card:hover .card-details { max-height: 500px; opacity: 1; margin-top: 20px; padding: 20px; border-top: 1px solid #2b3139; }
        
        .detail-table { width: 100%; border-collapse: collapse; font-size: 14px; }
        .detail-table th { color: #848e9c; text-align: left; padding: 10px; border-bottom: 1px solid #2b3139; font-weight: 600; font-size: 12px; }
        .detail-table td { color: #eaecef; text-align: left; padding: 10px; border-bottom: 1px solid #23262f; font-size: 13px; }
        .detail-table tr:last-child td { border-bottom: none; }
        
        .expand-hint { font-size: 11px; color: #555; margin-top: 5px; transition: 0.3s; cursor: pointer; }
        .schedule-card:hover .expand-hint { opacity: 0; }
        
        .st-open { color: #b2ff59; font-weight: bold; font-size: 14px; }
        .st-closed { color: #f6465d; font-weight: bold; font-size: 14px; }
        .st-wait { color: #f0b90b; font-weight: bold; font-size: 14px; }

        /* User Dropdown */
        .user-dropdown { position: relative; display: inline-block; }
        .user-btn { background: #1e2329; color: #eaecef; padding: 8px 16px; border-radius: 20px; border: 1px solid #2b3139; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: 0.3s; font-size: 14px; }
        .user-btn:hover { border-color: var(--primary-color); background: #2b3139; }
        .user-avatar-xs { width: 24px; height: 24px; background: var(--primary-color); color: #000; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; }
        .dropdown-content { display: none; position: absolute; right: 0; top: 100%; margin-top: 10px; background-color: #1e2329; min-width: 200px; box-shadow: 0 8px 24px rgba(0,0,0,0.5); border-radius: 12px; border: 1px solid #2b3139; z-index: 1000; overflow: visible; }
        .dropdown-content::before { content: ""; position: absolute; top: -20px; left: 0; width: 100%; height: 20px; background: transparent; }
        .user-dropdown:hover .dropdown-content { display: block; animation: fadeIn 0.2s; }
        .dropdown-content a { color: #eaecef; padding: 12px 16px; text-decoration: none; display: block; font-size: 14px; border-bottom: 1px solid #2b3139; transition: 0.2s; }
        .dropdown-content a:last-child { border-bottom: none; }
        .dropdown-content a:hover { background-color: #2b3139; color: var(--primary-color); padding-left: 20px; }
        .dropdown-content a.logout-item:hover { color: #f6465d; background-color: rgba(246, 70, 93, 0.1); }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-left"><div class="logo">üåø ECOBANK</div><nav class="nav"><a href="index.html" class="nav-link">‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</a><a href="trash_types.html" class="nav-link">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏¢‡∏∞‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</a><a href="leaderboard.html" class="nav-link">‡∏à‡∏±‡∏î‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</a><a href="exchange.html" class="nav-link active">‡∏ï‡∏•‡∏≤‡∏î‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏¢</a><a href="booths.html" class="nav-link">‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠</a><a href="rewards.html" class="nav-link">‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</a><a href="wallet.html" class="nav-link">‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏á‡∏¥‡∏ô</a></nav></div>
        <div id="authSection" class="header-right"></div>
    </header>

    <main class="container animate-fade-in">
        <div class="page-title">üìÖ ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠</div>
        <p class="page-subtitle">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏¢‡∏∞‡πÉ‡∏ô‡∏ä‡∏∏‡∏°‡∏ä‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤ (‡∏ä‡∏µ‡πâ‡∏ó‡∏µ‡πà‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏Ñ‡∏≤)</p>

        <div id="scheduleList" class="animate-slide-up">
            <div style="text-align:center; color:#666; padding:40px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á...</div>
        </div>

        <footer class="site-footer">
        <div class="footer-container">
            <div class="footer-col">
                <div class="footer-logo">üåø ECOBANK</div>
                <p class="footer-desc">
                    ‡πÅ‡∏û‡∏•‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏Ç‡∏¢‡∏∞‡∏î‡∏¥‡∏à‡∏¥‡∏ó‡∏±‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ä‡∏∏‡∏°‡∏ä‡∏ô<br>
                    ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ç‡∏¢‡∏∞‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ ‡∏•‡∏î‡πÇ‡∏•‡∏Å‡∏£‡πâ‡∏≠‡∏ô
                </p>
            </div>

            <div class="footer-col">
                <h4>‡πÄ‡∏°‡∏ô‡∏π‡∏•‡∏±‡∏î</h4>
                <ul class="footer-links">
                    <li><a href="index.html">‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</a></li>
                    <li><a href="trash_types.html">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏¢‡∏∞‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</a></li>
                    <li><a href="booths.html">‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠</a></li>
                    <li><a href="exchange.html">‡∏ï‡∏•‡∏≤‡∏î‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏¢</a></li>
                </ul>
            </div>

            <div class="footer-col">
                <h4>‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏£‡∏≤</h4>
                <ul class="footer-contact">
                    <li>üìû 011-111-111</li>
                    <li>üìß contact@ecobank.com</li>
                    <li>üìç ‡πÄ‡∏ó‡∏®‡∏ö‡∏≤‡∏•‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏™‡∏Å‡∏•‡∏ô‡∏Ñ‡∏£</li>
                </ul>
            </div>
        </div>
        
        <div class="footer-bottom">
            &copy; 2025 ECOBANK. All Rights Reserved.
        </div>
    </footer>

    </main>

    <script type="module">
        import { getEvents, getTrashTypes, showConfirm } from "./js/firebase-service.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { auth } from "./js/firebase-config.js";

        // Auth
        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('authSection').innerHTML = `
                    <div class="user-dropdown">
                        <div class="user-btn"><div class="user-avatar-xs">üë§</div><span>${user.email.split('@')[0]}</span><span style="font-size:10px; color:#888;">‚ñº</span></div>
                        <div class="dropdown-content">
                            <a href="profile.html">üë§ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß (Profile)</a><a href="wallet.html">üí∞ ‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏á‡∏¥‡∏ô (Wallet)</a><a href="#" id="logoutBtn" class="logout-item">üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</a>
                        </div>
                    </div>`;
                document.getElementById('logoutBtn').addEventListener('click', async (e) => { e.preventDefault(); if(await showConfirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô","‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö?")) { await signOut(auth); window.location.href='login.html'; } });
            } else {
                document.getElementById('authSection').innerHTML = `<a href="login.html" class="btn btn-login">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</a><a href="register.html" class="btn btn-register">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</a>`;
            }
        });

        // Main Logic
        async function initSchedule() {
            try {
                const events = await getEvents();
                const allTrash = await getTrashTypes(); // ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏¢‡∏∞‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏°‡∏≤‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö ID
                const container = document.getElementById('scheduleList');

                if (events.length === 0) {
                    container.innerHTML = '<div style="text-align:center; color:#666; padding:40px;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÄ‡∏£‡πá‡∏ß‡πÜ ‡∏ô‡∏µ‡πâ</div>';
                    return;
                }

                events.sort((a, b) => new Date(a.date || 0) - new Date(b.date || 0));

                container.innerHTML = events.map(evt => {
                    const d = evt.date ? new Date(evt.date) : new Date();
                    const day = d.getDate();
                    const months = ["‡∏°.‡∏Ñ.","‡∏Å.‡∏û.","‡∏°‡∏µ.‡∏Ñ.","‡πÄ‡∏°.‡∏¢.","‡∏û.‡∏Ñ.","‡∏°‡∏¥.‡∏¢.","‡∏Å.‡∏Ñ.","‡∏™.‡∏Ñ.","‡∏Å.‡∏¢.","‡∏ï.‡∏Ñ.","‡∏û.‡∏¢.","‡∏ò.‡∏Ñ."];
                    const month = months[d.getMonth()];

                    // 1. ‡∏Å‡∏£‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏¢‡∏∞‡∏ó‡∏µ‡πà‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠‡∏ô‡∏µ‡πâ‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö (Accepted Trash)
                    const acceptedTrashList = allTrash.filter(t => 
                        evt.accepted_trash_ids && evt.accepted_trash_ids.includes(t.id)
                    );

                    // 2. ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Tags (‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏≤‡∏£‡πå‡∏î)
                    let tagsHtml = '';
                    if (acceptedTrashList.length > 0) {
                        // ‡πÇ‡∏ä‡∏ß‡πå‡πÅ‡∏Ñ‡πà 3 ‡∏≠‡∏±‡∏ô‡πÅ‡∏£‡∏Å ‡∏ñ‡πâ‡∏≤‡πÄ‡∏¢‡∏≠‡∏∞‡πÄ‡∏Å‡∏¥‡∏ô
                        tagsHtml = acceptedTrashList.slice(0, 3).map(t => `<span class="tag">${t.name}</span>`).join('');
                        if (acceptedTrashList.length > 3) tagsHtml += `<span class="tag">+${acceptedTrashList.length - 3}</span>`;
                    } else {
                        tagsHtml = `<span class="tag" style="color:#666; background:rgba(255,255,255,0.05);">‡∏£‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</span>`;
                    }

                    // 3. ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏ô Dropdown (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠)
                    let tableRows = '';
                    if (acceptedTrashList.length > 0) {
                        tableRows = acceptedTrashList.map(t => `
                            <tr>
                                <td>${t.icon || 'üì¶'} ${t.name}</td>
                                <td style="color: var(--primary-color); font-weight:bold;">${t.price_per_unit} ‡∏ø/kg</td>
                                <td style="color:#888;">${t.category}</td>
                            </tr>
                        `).join('');
                    } else {
                        // ‡∏ñ‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏ ‡πÉ‡∏´‡πâ‡πÇ‡∏ä‡∏ß‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (Fallback)
                        tableRows = allTrash.map(t => `
                            <tr>
                                <td>${t.icon || 'üì¶'} ${t.name}</td>
                                <td style="color: var(--primary-color); font-weight:bold;">${t.price_per_unit} ‡∏ø/kg</td>
                                <td style="color:#888;">${t.category}</td>
                            </tr>
                        `).join('');
                    }

                    // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
                    let statusHtml = '<span class="st-wait">‚è≥ ‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</span>';
                    if(evt.status === 'open') statusHtml = '<span class="st-open">‚óè ‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠</span>';
                    else if(evt.status === 'closed') statusHtml = '<span class="st-closed">‚óè ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠</span>';

                    return `
                    <div class="schedule-card">
                        <div class="card-header-row">
                            <div class="date-box">
                                <div class="date-day">${day}</div>
                                <div class="date-month">${month}</div>
                            </div>
                            <div style="flex: 1;">
                                <h3 style="font-size: 18px; margin-bottom: 5px; color:#fff;">üìç ${evt.name}</h3>
                                <div style="margin-bottom: 5px; color: #848e9c; font-size: 14px;">‡πÄ‡∏ß‡∏•‡∏≤: 09:00 - 16:00 ‡∏ô. | ${evt.district}</div>
                                <div>${tagsHtml}</div> </div>
                            <div style="text-align: right;">
                                <div>${statusHtml}</div>
                                <div class="expand-hint">‡∏ä‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î ‚ñº</div>
                            </div>
                        </div>
                        
                        <div class="card-details">
                            <h4 style="font-size: 14px; margin-bottom: 15px; color: var(--primary-color); border-bottom:1px solid #333; padding-bottom:10px;">üìã ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏à‡∏∏‡∏î‡∏ô‡∏µ‡πâ‡∏£‡∏±‡∏ö)</h4>
                            <table class="detail-table">
                                <thead><tr><th width="50%">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡∏¢‡∏∞</th><th width="30%">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</th><th width="20%">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</th></tr></thead>
                                <tbody>
                                    ${tableRows}
                                </tbody>
                            </table>
                        </div>
                    </div>`;
                }).join('');

            } catch (err) { console.error(err); }
        }

        initSchedule();
    </script>
</body>
</html>