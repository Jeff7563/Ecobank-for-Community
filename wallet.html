<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ECOBANK</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üåø</text></svg>">
    <link rel="stylesheet" href="css/style.css">
    <style>
        .wallet-card {
            background: linear-gradient(135deg, #1e2329 0%, #15181d 100%);
            border: 1px solid #2b3139; border-radius: 20px; padding: 40px;
            text-align: center; margin-bottom: 30px; position: relative; overflow: hidden;
        }
        .wallet-card::before {
            content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle, rgba(255, 215, 0, 0.05) 0%, rgba(0,0,0,0) 70%); pointer-events: none; /* ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏™‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏ó‡∏≠‡∏á */
        }
        .balance-title { color: var(--text-muted); font-size: 16px; margin-bottom: 10px; }
        
        /* ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏ó‡∏≠‡∏á (Points) */
        .balance-amount { font-size: 56px; font-weight: 800; color: #ffd700; letter-spacing: -1px; text-shadow: 0 0 20px rgba(255, 215, 0, 0.2); }
        .balance-unit { font-size: 20px; color: var(--text-main); font-weight: normal; margin-left: 10px; }
        
        /* ‡∏õ‡∏∏‡πà‡∏° Action ‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà */
        .action-container { display: flex; justify-content: center; margin-bottom: 40px; }
        .btn-redeem {
            background: linear-gradient(45deg, #f0b90b, #d4a008); /* ‡∏™‡∏µ‡∏ó‡∏≠‡∏á */
            color: #000;
            border: none;
            padding: 12px 35px;
            border-radius: 30px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
            display: flex; align-items: center; gap: 8px;
            text-decoration: none; /* ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö tag a */
            box-shadow: 0 4px 15px rgba(240, 185, 11, 0.3);
        }
        .btn-redeem:hover { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(240, 185, 11, 0.5); }

        .tx-item { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 15px 20px; border-bottom: 1px solid #2b3139; transition: 0.2s; 
            cursor: pointer; border-radius: 8px;
        }
        .tx-item:hover { background: #2b3139; transform: translateX(5px); }
        .tx-icon { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; margin-right: 15px; }
        
        .content-tabs { display: flex; gap: 30px; margin: 30px 0 20px 0; border-bottom: 1px solid #2b3139; }
        .content-tab { padding: 10px 0; color: #848e9c; cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.2s; }
        .content-tab.active { color: #eaecef; border-bottom-color: var(--primary-color); }
        
        .portfolio-item { 
            background: #1e2329; border: 1px solid #2b3139; border-radius: 12px; padding: 15px; 
            display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; 
        }

        /* --- Receipt & Dropdown Styles --- */
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.85); backdrop-filter: blur(8px); align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s; }
        .modal.show { display: flex; opacity: 1; }
        .receipt-paper { background: #fff; color: #000; width: 320px; padding: 30px; border-radius: 0; position: relative; box-shadow: 0 0 50px rgba(0,0,0,0.5); font-family: 'Courier New', Courier, monospace; transform: scale(0.9); transition: transform 0.3s; background-image: radial-gradient(#eee 1px, transparent 1px); background-size: 10px 10px; }
        .modal.show .receipt-paper { transform: scale(1); }
        .receipt-paper::after { content: ""; position: absolute; bottom: -10px; left: 0; width: 100%; height: 10px; background: linear-gradient(45deg, transparent 33.333%, #fff 33.333%, #fff 66.667%, transparent 66.667%), linear-gradient(-45deg, transparent 33.333%, #fff 33.333%, #fff 66.667%, transparent 66.667%); background-size: 20px 20px; }
        .receipt-header { text-align: center; border-bottom: 2px dashed #000; padding-bottom: 15px; margin-bottom: 15px; }
        .receipt-logo { font-size: 24px; font-weight: bold; }
        .receipt-meta { font-size: 12px; color: #333; margin-top: 5px; }
        .receipt-table { width: 100%; font-size: 12px; margin-bottom: 15px; }
        .receipt-table th { text-align: left; border-bottom: 1px solid #000; padding: 5px 0; }
        .receipt-table td { padding: 5px 0; vertical-align: top; }
        .receipt-total { border-top: 2px dashed #000; padding-top: 10px; text-align: right; font-size: 18px; font-weight: bold; margin-bottom: 5px; }
        .receipt-points-info { text-align: right; font-size: 12px; color: #555; line-height: 1.5; }
        .receipt-footer { text-align: center; font-size: 10px; color: #555; margin-top: 20px;}
        .close-receipt { position: absolute; top: -40px; right: 0; color: #fff; font-size: 30px; cursor: pointer; }

        /* User Dropdown */
        .user-dropdown { position: relative; display: inline-block; }
        .user-btn { background: #1e2329; color: #eaecef; padding: 8px 16px; border-radius: 20px; border: 1px solid #2b3139; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: 0.3s; font-size: 14px; }
        .user-btn:hover { border-color: var(--primary-color); background: #2b3139; }
        .user-avatar-xs { width: 24px; height: 24px; background: var(--primary-color); color: #000; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; }
        
        .dropdown-content { 
            display: none; position: absolute; right: 0; top: 100%; margin-top: 10px; 
            background-color: #1e2329; min-width: 200px; box-shadow: 0 8px 24px rgba(0,0,0,0.5); 
            border-radius: 12px; border: 1px solid #2b3139; z-index: 1000; overflow: visible; 
        }
        .dropdown-content::before { content: ""; position: absolute; top: -20px; left: 0; width: 100%; height: 20px; background: transparent; }
        .user-dropdown:hover .dropdown-content { display: block; animation: fadeIn 0.2s; }
        
        .dropdown-content a { color: #eaecef; padding: 12px 16px; text-decoration: none; display: block; font-size: 14px; border-bottom: 1px solid #2b3139; transition: 0.2s; }
        .dropdown-content a:last-child { border-bottom: none; }
        .dropdown-content a:hover { background-color: #2b3139; color: var(--primary-color); padding-left: 20px; }
        .dropdown-content a.logout-item:hover { color: #f6465d; background-color: rgba(246, 70, 93, 0.1); }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-left"><div class="logo">üåø ECOBANK</div><nav class="nav"><a href="index.html" class="nav-link">‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</a><a href="trash_types.html" class="nav-link">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏¢‡∏∞‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</a><a href="leaderboard.html" class="nav-link">‡∏à‡∏±‡∏î‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</a><a href="exchange.html" class="nav-link">‡∏ï‡∏•‡∏≤‡∏î‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏¢</a><a href="booths.html" class="nav-link">‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠</a><a href="rewards.html" class="nav-link">‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</a><a href="wallet.html" class="nav-link active">‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏á‡∏¥‡∏ô</a></nav></div>
        <div id="authSection" class="header-right"></div>
    </header>

    <main class="container animate-fade-in">
        <div class="page-title">üí∞ My Wallet</div>
        <div id="walletContent" style="display:none;">
            
            <div class="wallet-card animate-slide-up">
                <div class="balance-title">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏∞‡∏™‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</div>
                <div class="balance-amount"><span id="pointText">0</span><span class="balance-unit">Points</span></div>
                <div style="margin-top: 20px; font-size: 14px; color: var(--text-muted);">User ID: <span id="userIdDisplay">...</span></div>
            </div>

            <div class="action-container">
                <a href="rewards.html" class="btn-redeem">
                    üéÅ ‡πÅ‡∏•‡∏Å‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏• (Redeem)
                </a>
            </div>

            <div class="content-tabs">
                <div class="content-tab active" onclick="switchTab('portfolio')">‡∏û‡∏≠‡∏£‡πå‡∏ï‡πÇ‡∏ü‡∏•‡∏¥‡πÇ‡∏≠‡∏Ç‡∏¢‡∏∞</div>
                <div class="content-tab" onclick="switchTab('history')">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
            </div>

            <div id="portfolioTab"><div id="portfolioGrid">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div></div>
            <div id="historyTab" style="display: none;">
                <div style="margin-bottom:10px; font-size:12px; color:#666; text-align:right;">* ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</div>
                <div id="transactionList" class="table-container">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
            </div>
        </div>

        <div id="loginWarning" style="display:none; text-align: center; padding: 60px; background: var(--bg-card); border-radius: 12px;">
            <div style="font-size: 50px; margin-bottom: 20px;">üîí</div>
            <h2>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h2>
            <a href="login.html" class="btn btn-primary">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</a>
        </div>

        <footer class="site-footer">
        <div class="footer-container">
            <div class="footer-col">
                <div class="footer-logo">üåø ECOBANK</div>
                <p class="footer-desc">
                    ‡πÅ‡∏û‡∏•‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏Ç‡∏¢‡∏∞‡∏î‡∏¥‡∏à‡∏¥‡∏ó‡∏±‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ä‡∏∏‡∏°‡∏ä‡∏ô<br>
                    ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ç‡∏¢‡∏∞‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ ‡∏•‡∏î‡πÇ‡∏•‡∏Å‡∏£‡πâ‡∏≠‡∏ô
                </p>
            </div>

            <div class="footer-col">
                <h4>‡πÄ‡∏°‡∏ô‡∏π‡∏•‡∏±‡∏î</h4>
                <ul class="footer-links">
                    <li><a href="index.html">‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</a></li>
                    <li><a href="trash_types.html">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏¢‡∏∞‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</a></li>
                    <li><a href="booths.html">‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠</a></li>
                    <li><a href="exchange.html">‡∏ï‡∏•‡∏≤‡∏î‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏¢</a></li>
                </ul>
            </div>

            <div class="footer-col">
                <h4>‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏£‡∏≤</h4>
                <ul class="footer-contact">
                    <li>üìû 011-111-111</li>
                    <li>üìß contact@ecobank.com</li>
                    <li>üìç ‡πÄ‡∏ó‡∏®‡∏ö‡∏≤‡∏•‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏™‡∏Å‡∏•‡∏ô‡∏Ñ‡∏£</li>
                </ul>
            </div>
        </div>
        
        <div class="footer-bottom">
            &copy; 2025 ECOBANK. All Rights Reserved.
        </div>
    </footer>
        
    </main>

    <div class="modal" id="receiptModal">
        <div style="position:relative;">
            <span class="close-receipt" onclick="closeReceipt()">&times;</span>
            <div class="receipt-paper">
                <div class="receipt-header">
                    <div class="receipt-logo">üåø ECOBANK</div>
                    <div class="receipt-meta">RECEIPT / Tax Invoice</div>
                    <div class="receipt-meta" id="rcpDate">Date: -</div>
                    <div class="receipt-meta" id="rcpId">ID: -</div>
                </div>
                <table class="receipt-table">
                    <thead><tr><th>Item</th><th style="text-align:right;">Total</th></tr></thead>
                    <tbody id="rcpItems"></tbody>
                </table>
                <div class="receipt-total" id="rcpTotal">Paid Cash: 0.00 THB</div>
                
                <div style="border-top: 1px dotted #000; margin-top: 10px; padding-top: 10px;">
                    <div class="receipt-points-info">Points Earned: <b id="rcpEarned">0</b></div>
                    <div class="receipt-points-info">Current Balance: <b id="rcpBalance">0</b></div>
                </div>

                <div class="receipt-footer">Thank you for saving the world!<br>www.ecobank.com<div style="margin-top:10px; font-size:24px;">üå±</div></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { 
            getUserWallet, getUserTransactions, getTrashTypes, getTrashTypeById,
            showPopup, showConfirm 
        } from "./js/firebase-service.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { auth } from "./js/firebase-config.js";

        let currentUser = null;
        let globalTransactions = [];
        let allTrashTypes = [];
        let currentPoints = 0; // ‡πÄ‡∏Å‡πá‡∏ö‡πÅ‡∏ï‡πâ‡∏°‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ‡πÇ‡∏ä‡∏ß‡πå‡πÉ‡∏ô‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('authSection').innerHTML = `
                    <div class="user-dropdown">
                        <div class="user-btn"><div class="user-avatar-xs">üë§</div><span>${user.email.split('@')[0]}</span><span style="font-size:10px; color:#888;">‚ñº</span></div>
                        <div class="dropdown-content">
                            <a href="profile.html">üë§ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß (Profile)</a><a href="wallet.html">üí∞ ‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏á‡∏¥‡∏ô (Wallet)</a><a href="#" id="logoutBtn" class="logout-item">üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</a>
                        </div>
                    </div>`;
                document.getElementById('logoutBtn').addEventListener('click', async (e) => { e.preventDefault(); if(await showConfirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô","‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö?")) { await signOut(auth); window.location.href='login.html'; } });
                
                document.getElementById('walletContent').style.display = 'block';
                document.getElementById('loginWarning').style.display = 'none';
                document.getElementById('userIdDisplay').innerText = user.uid.slice(0, 8) + "...";
                
                allTrashTypes = await getTrashTypes();
                await loadWalletData();
            } else {
                document.getElementById('authSection').innerHTML = `<a href="login.html" class="btn btn-login">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</a>`;
                document.getElementById('walletContent').style.display = 'none';
                document.getElementById('loginWarning').style.display = 'block';
            }
        });

        window.switchTab = (tabName) => {
            document.querySelectorAll('.content-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('portfolioTab').style.display = tabName === 'portfolio' ? 'block' : 'none';
            document.getElementById('historyTab').style.display = tabName === 'history' ? 'block' : 'none';
        }

        async function loadWalletData() {
            if (!currentUser) return;
            const walletData = await getUserWallet(currentUser.uid);
            
            // ‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÄ‡∏õ‡πá‡∏ô "‡πÅ‡∏ï‡πâ‡∏°" (Points)
            currentPoints = walletData?.points || 0;
            animateValue("pointText", 0, currentPoints, 1000);

            // Portfolio Logic
            const portfolio = walletData?.portfolio || {};
            const pContainer = document.getElementById('portfolioGrid');
            if (Object.keys(portfolio).length === 0) pContainer.innerHTML = '<div style="text-align:center; padding:20px; color:#888;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡∏¢‡∏∞‡πÉ‡∏ô‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏≠‡∏á</div>';
            else {
                let pHtml = '';
                for (const [id, qty] of Object.entries(portfolio)) {
                    let trash = allTrashTypes.find(t => t.id === id);
                    if (!trash) { try { trash = await getTrashTypeById(id); } catch (e) {} }

                    const name = trash ? trash.name : `<span style="color:#666;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏° (ID: ${id.slice(0,4)}...)</span>`;
                    const icon = trash ? (trash.icon || 'üì¶') : '‚ùì';
                    
                    pHtml += `<div class="portfolio-item"><div style="display:flex; align-items:center; gap:10px;"><span style="font-size:24px;">${icon}</span><div>${name}</div></div><div style="font-weight:bold; color:var(--primary-color);">${parseFloat(qty).toFixed(2)} kg</div></div>`;
                }
                pContainer.innerHTML = pHtml;
            }

            // Transactions
            globalTransactions = await getUserTransactions(currentUser.uid);
            const txContainer = document.getElementById('transactionList');
            if (globalTransactions.length === 0) txContainer.innerHTML = `<div style="padding: 30px; text-align: center; color: var(--text-muted);">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß</div>`;
            else {
                txContainer.innerHTML = globalTransactions.map((tx, index) => {
                    let dateStr = tx.created_at?.seconds ? new Date(tx.created_at.seconds * 1000).toLocaleString('th-TH') : "‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà";
                    const isIncome = (tx.type === 'deposit' || tx.type === 'sell');
                    
                    // ‡∏õ‡∏£‡∏±‡∏ö Label ‡πÉ‡∏´‡πâ‡∏™‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢
                    let label = tx.type === 'sell' ? '‡∏Ç‡∏≤‡∏¢‡∏Ç‡∏¢‡∏∞ (‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î)' : (tx.type === 'redeem' ? '‡πÅ‡∏•‡∏Å‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•' : tx.type);
                    
                    const sign = isIncome ? '+' : '';
                    const colorClass = isIncome ? 'text-up' : 'text-down'; 
                    
                    // ‡πÅ‡∏™‡∏î‡∏á‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡∏≤‡∏¢, ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏•‡∏Å‡∏Ç‡∏≠‡∏á
                    let amountDisplay = '';
                    if (tx.type === 'sell') {
                        amountDisplay = `${sign}${Math.abs(tx.amount).toFixed(2)} ‡∏ø`;
                    } else if (tx.type === 'redeem') {
                        amountDisplay = `${Math.abs(tx.amount)} Pts`;
                    } else {
                        amountDisplay = `${sign}${Math.abs(tx.amount)}`;
                    }
                    
                    return `
                    <div class="tx-item" onclick="openReceipt(${index})">
                        <div style="display:flex; align-items:center;">
                            <div class="tx-icon" style="background: #2b3139;">${isIncome?'üí∞':'üéÅ'}</div>
                            <div>
                                <div style="font-weight:600; color:var(--text-main);">${label}</div>
                                <div style="font-size:12px; color:var(--text-muted);">${dateStr}</div>
                            </div>
                        </div>
                        <div class="${colorClass}" style="font-weight:bold; font-size:16px;">
                            ${amountDisplay}
                        </div>
                    </div>`;
                }).join('');
            }
        }

        // --- Receipt Logic (Updated) ---
        window.openReceipt = (index) => {
            const tx = globalTransactions[index];
            if(!tx) return;
            document.getElementById('rcpDate').innerText = `Date: ${tx.created_at?.seconds ? new Date(tx.created_at.seconds * 1000).toLocaleString('th-TH') : "N/A"}`;
            document.getElementById('rcpId').innerText = `Ref: ${tx.id.slice(0,8).toUpperCase()}`;
            
            // 1. ‡πÅ‡∏™‡∏î‡∏á‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô (Paid Cash)
            let totalCash = 0;
            if (tx.type === 'sell') {
                totalCash = Math.abs(tx.amount);
                document.getElementById('rcpTotal').innerText = `Paid Cash: ${totalCash.toFixed(2)} THB`;
            } else if (tx.type === 'redeem') {
                document.getElementById('rcpTotal').innerText = `Redeemed: ${Math.abs(tx.amount)} Points`;
            } else {
                document.getElementById('rcpTotal').innerText = `Total: ${Math.abs(tx.amount)}`;
            }

            // 2. ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ï‡πâ‡∏°‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö (Points Earned)
            // (‡∏™‡∏°‡∏°‡∏ï‡∏¥ 1 ‡∏ö‡∏≤‡∏ó = 1 ‡πÅ‡∏ï‡πâ‡∏° ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢)
            let earnedPoints = 0;
            if (tx.type === 'sell') {
                earnedPoints = Math.floor(Math.abs(tx.amount));
                document.getElementById('rcpEarned').innerText = `+${earnedPoints}`;
            } else {
                document.getElementById('rcpEarned').innerText = "0";
            }

            // 3. ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ï‡πâ‡∏°‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
            document.getElementById('rcpBalance').innerText = currentPoints.toLocaleString();

            // ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
            let itemsHtml = '';
            if (tx.type === 'sell' && tx.items && Array.isArray(tx.items)) {
                tx.items.forEach(item => {
                    itemsHtml += `<tr><td>${item.name}<br><span style="color:#666;">${item.weight}kg x ${item.price}</span></td><td style="text-align:right;">${item.subtotal.toFixed(2)}</td></tr>`;
                });
            } else {
                const label = tx.detail || (tx.type === 'withdraw' ? 'Withdrawal' : 'Transaction');
                itemsHtml = `<tr><td>${label}</td><td style="text-align:right;">${Math.abs(tx.amount)}</td></tr>`;
            }
            document.getElementById('rcpItems').innerHTML = itemsHtml;
            document.getElementById('receiptModal').classList.add('show');
        };
        window.closeReceipt = () => document.getElementById('receiptModal').classList.remove('show');

        function animateValue(id, start, end, duration) {
            const obj = document.getElementById(id); if(!obj) return;
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                obj.innerHTML = Math.floor(progress * (end - start) + start).toLocaleString(); // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ï‡πá‡∏° (‡πÅ‡∏ï‡πâ‡∏°)
                if (progress < 1) window.requestAnimationFrame(step);
            };
            window.requestAnimationFrame(step);
        }
    </script>
</body>
</html>