<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠ - ECOBANK</title>
    <link rel="stylesheet" href="css/style.css">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        /* CSS ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏´‡∏ô‡πâ‡∏≤ Map */
        .map-container {
            height: 500px;
            width: 100%;
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid #2b3139;
            margin-bottom: 30px;
            position: relative;
            z-index: 1;
        }
        #map { height: 100%; width: 100%; }

        .location-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .location-card {
            background: #1e2329;
            border: 1px solid #2b3139;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .location-card:hover { border-color: var(--primary-color); transform: translateY(-5px); }
        
        .loc-title { font-size: 18px; font-weight: bold; margin-bottom: 5px; color: #fff; }
        .loc-addr { font-size: 14px; color: #848e9c; margin-bottom: 10px; display: flex; align-items: center; gap: 5px; }
        .loc-status { font-size: 12px; font-weight: bold; display: flex; align-items: center; justify-content: space-between; }
        
        .status-open { color: #b2ff59; }
        .status-closed { color: #f6465d; }

        .btn-nav {
            background: #2b3139; color: #fff; border: 1px solid #444;
            padding: 8px 10px; border-radius: 6px; font-size: 12px;
            cursor: pointer; width: 100%; margin-top: 15px;
            transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 5px;
            text-decoration: none;
        }
        .btn-nav:hover { background: #fff; color: #000; }

        /* Dropdown Styles */
        .user-dropdown { position: relative; display: inline-block; }
        .user-btn { background: #1e2329; color: #eaecef; padding: 8px 16px; border-radius: 20px; border: 1px solid #2b3139; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: 0.3s; font-size: 14px; }
        .user-btn:hover { border-color: var(--primary-color); background: #2b3139; }
        .user-avatar-xs { width: 24px; height: 24px; background: var(--primary-color); color: #000; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; }
        .dropdown-content { display: none; position: absolute; right: 0; top: 100%; margin-top: 10px; background-color: #1e2329; min-width: 200px; box-shadow: 0 8px 24px rgba(0,0,0,0.5); border-radius: 12px; border: 1px solid #2b3139; z-index: 1000; overflow: visible; }
        .dropdown-content::before { content: ""; position: absolute; top: -20px; left: 0; width: 100%; height: 20px; background: transparent; }
        .user-dropdown:hover .dropdown-content { display: block; animation: fadeIn 0.2s; }
        .dropdown-content a { color: #eaecef; padding: 12px 16px; text-decoration: none; display: block; font-size: 14px; border-bottom: 1px solid #2b3139; transition: 0.2s; }
        .dropdown-content a:last-child { border-bottom: none; }
        .dropdown-content a:hover { background-color: #2b3139; color: var(--primary-color); padding-left: 20px; }
        .dropdown-content a.logout-item:hover { color: #f6465d; background-color: rgba(246, 70, 93, 0.1); }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-left"><div class="logo">üåø ECOBANK</div><nav class="nav"><a href="index.html" class="nav-link">‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</a><a href="trash_types.html" class="nav-link">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏¢‡∏∞‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</a><a href="leaderboard.html" class="nav-link">‡∏à‡∏±‡∏î‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</a><a href="exchange.html" class="nav-link">‡∏ï‡∏•‡∏≤‡∏î‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏¢</a><a href="booths.html" class="nav-link active">‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠</a><a href="rewards.html" class="nav-link">‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</a><a href="wallet.html" class="nav-link">‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏á‡∏¥‡∏ô</a></nav></div>
        <div id="authSection" class="header-right"></div>
    </header>

    <main class="container animate-fade-in">
        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
            <div style="font-size: 30px;">üó∫Ô∏è</div>
            <div>
                <div class="page-title" style="margin-bottom:0;">‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠</div>
                <p class="page-subtitle" style="margin-bottom:0;">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏¢‡∏∞‡πÉ‡∏Å‡∏•‡πâ‡∏ö‡πâ‡∏≤‡∏ô‡∏Ñ‡∏∏‡∏ì</p>
            </div>
        </div>

        <div id="map" class="map-container"></div>

        <h3 style="margin-bottom: 20px; border-bottom: 1px solid #2b3139; padding-bottom: 10px;">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
        <div id="boothList" class="location-list">
            <div style="text-align:center; grid-column:1/-1; color:#666; padding:40px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
        </div>
    </main>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script type="module">
        import { getEvents, showConfirm } from "./js/firebase-service.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { auth } from "./js/firebase-config.js";

        // Auth & Dropdown
        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('authSection').innerHTML = `
                    <div class="user-dropdown">
                        <div class="user-btn"><div class="user-avatar-xs">üë§</div><span>${user.email.split('@')[0]}</span><span style="font-size:10px; color:#888;">‚ñº</span></div>
                        <div class="dropdown-content">
                            <a href="profile.html">üë§ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß (Profile)</a><a href="wallet.html">üí∞ ‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏á‡∏¥‡∏ô (Wallet)</a><a href="#" id="logoutBtn" class="logout-item">üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</a>
                        </div>
                    </div>`;
                document.getElementById('logoutBtn').addEventListener('click', async (e) => { e.preventDefault(); if(await showConfirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô","‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö?")) { await signOut(auth); window.location.href='login.html'; } });
            } else {
                document.getElementById('authSection').innerHTML = `<a href="login.html" class="btn btn-login">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</a>`;
            }
        });

        // Map Variables
        let map;
        let markers = [];

        async function initMap() {
            // 1. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà (‡πÄ‡∏ã‡πá‡∏ï‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏Å‡∏•‡∏ô‡∏Ñ‡∏£)
            map = L.map('map').setView([17.165, 104.145], 13);

            // 2. ‡πÉ‡∏™‡πà‡πÅ‡∏ú‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≤‡∏Å OpenStreetMap (‡∏ü‡∏£‡∏µ)
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);

            // 3. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠
            const booths = await getEvents();
            const listContainer = document.getElementById('boothList');
            
            if(booths.length === 0) {
                listContainer.innerHTML = '<div style="text-align:center; grid-column:1/-1; color:#666;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠</div>';
                return;
            }

            listContainer.innerHTML = '';

            booths.forEach(booth => {
                // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏û‡∏¥‡∏Å‡∏±‡∏î ‡πÉ‡∏´‡πâ‡∏™‡∏∏‡πà‡∏°‡πÉ‡∏Å‡∏•‡πâ‡πÜ ‡∏™‡∏Å‡∏•‡∏ô‡∏Ñ‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠ Demo (17.16xx, 104.14xx)
                // (‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏£‡∏¥‡∏á ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÄ‡∏≠‡∏á)
                const lat = booth.lat || (17.16 + (Math.random() * 0.02));
                const lng = booth.lng || (104.14 + (Math.random() * 0.02));

                // 4. ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏∏‡∏î (Marker) ‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
                const marker = L.marker([lat, lng]).addTo(map)
                    .bindPopup(`<b>${booth.name}</b><br>${booth.district}`);
                
                markers.push({ id: booth.id, marker: marker });

                // 5. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á
                const statusHtml = booth.status === 'open' 
                    ? '<span class="status-open">‚óè ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</span>' 
                    : '<span class="status-closed">‚óè ‡∏õ‡∏¥‡∏î‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß</span>';

                const card = document.createElement('div');
                card.className = 'location-card';
                card.innerHTML = `
                    <div style="display:flex; justify-content:space-between;">
                        <span style="font-size:10px; background:#f06292; color:#fff; padding:2px 6px; border-radius:4px;">24 H</span>
                        ${statusHtml}
                    </div>
                    <div class="loc-title" style="margin-top:10px;">${booth.name}</div>
                    <div class="loc-addr">üìç ${booth.address} (${booth.district})</div>
                    <div class="loc-status">
                        <span>‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏Å‡∏≤‡∏£: ${booth.hours || '08:00 - 17:00'}</span>
                        <span>üìû ${booth.phone || '-'}</span>
                    </div>
                    <a href="https://www.google.com/maps/search/?api=1&query=${lat},${lng}" target="_blank" class="btn-nav">
                        ‡∏ô‡∏≥‡∏ó‡∏≤‡∏á ‚Üó
                    </a>
                `;
                
                // ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏õ‡∏´‡∏≤
                card.onclick = () => {
                    map.flyTo([lat, lng], 16);
                    marker.openPopup();
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                };

                listContainer.appendChild(card);
            });
        }

        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
        initMap();
    </script>
</body>
</html>