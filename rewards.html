<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ï‡∏•‡∏≤‡∏î‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏¢ - ECOBANK</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .points-banner {
            background: linear-gradient(135deg, #1e2329 0%, #15181d 100%);
            border: 1px solid var(--primary-color);
            border-radius: 16px;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 30px;
            box-shadow: 0 0 20px rgba(178,255,89,0.1);
        }
        .my-points {
            font-size: 32px;
            font-weight: 800;
            color: var(--primary-color);
        }
        .points-label { font-size: 14px; color: #848e9c; }

        /* Grid ‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏• */
        .rewards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
        }

        .reward-card {
            background: #1e2329;
            border: 1px solid #2b3139;
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            transition: 0.3s;
            position: relative;
            overflow: hidden;
        }
        .reward-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary-color);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .reward-icon { font-size: 50px; margin-bottom: 15px; display: inline-block; }
        .reward-name { font-weight: bold; font-size: 16px; margin-bottom: 5px; color: #fff; }
        .reward-desc { font-size: 12px; color: #848e9c; margin-bottom: 15px; height: 32px; overflow: hidden; }
        
        .reward-cost {
            background: rgba(178, 255, 89, 0.1);
            color: var(--primary-color);
            padding: 5px 10px;
            border-radius: 20px;
            font-weight: bold;
            display: inline-block;
            margin-bottom: 15px;
        }

        .btn-redeem {
            width: 100%;
            padding: 10px;
            background: transparent;
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
        }
        .btn-redeem:hover {
            background: var(--primary-color);
            color: #000;
        }
        .btn-redeem:disabled {
            border-color: #444; color: #666; cursor: not-allowed; background: transparent;
        }
        /* --- User Dropdown Style (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà) --- */
        .user-dropdown {
            position: relative;
            display: inline-block;
        }

        .user-btn {
            background: #1e2329;
            color: #eaecef;
            padding: 8px 16px;
            border-radius: 20px;
            border: 1px solid #2b3139;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: 0.3s;
            font-size: 14px;
        }

        .user-btn:hover {
            border-color: var(--primary-color);
            background: #2b3139;
        }

        .user-avatar-xs {
            width: 24px; height: 24px;
            background: var(--primary-color);
            color: #000;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 14px;
        }

        /* ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Class ‡∏ô‡∏µ‡πâ */
        .dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            
            /* üëá 1. ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å 110% ‡πÄ‡∏õ‡πá‡∏ô 100% ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏°‡∏±‡∏ô‡∏ä‡∏¥‡∏î‡∏Ç‡∏≠‡∏ö‡∏õ‡∏∏‡πà‡∏° */
            top: 100%; 
            
            /* üëá 2. ‡πÉ‡∏ä‡πâ margin ‡∏î‡∏±‡∏ô‡∏•‡∏á‡∏°‡∏≤‡πÅ‡∏ó‡∏ô (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏°‡∏µ‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏™‡∏ß‡∏¢‡πÜ ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) */
            margin-top: 10px; 
            
            background-color: #1e2329;
            min-width: 200px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.5);
            border-radius: 12px;
            border: 1px solid #2b3139;
            z-index: 1000;
            overflow: visible; /* ‚úÖ ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç! ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô visible ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏™‡∏∞‡∏û‡∏≤‡∏ô (::before) ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ */
        }

        /* üî• ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ: ‡∏™‡∏∞‡∏û‡∏≤‡∏ô‡∏•‡πà‡∏≠‡∏á‡∏´‡∏ô (Invisible Bridge) */
        .dropdown-content::before {
            content: "";
            position: absolute;
            top: -20px; /* ‡∏î‡∏±‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ‡∏Ç‡πâ‡∏≤‡∏á‡∏ö‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π */
            left: 0;
            width: 100%;
            height: 20px; /* ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏Ç‡∏≠‡∏á‡∏™‡∏∞‡∏û‡∏≤‡∏ô */
            background: transparent; /* ‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÉ‡∏™ ‡∏°‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏´‡πá‡∏ô‡πÅ‡∏ï‡πà‡πÄ‡∏°‡∏≤‡∏™‡πå‡∏à‡∏±‡∏ö‡πÑ‡∏î‡πâ */
        }

        /* ‡πÇ‡∏ä‡∏ß‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏≤‡πÄ‡∏°‡∏≤‡∏™‡πå‡∏ä‡∏µ‡πâ */
        .user-dropdown:hover .dropdown-content {
            display: block;
            animation: fadeIn 0.2s;
        }

        .dropdown-content a {
            color: #eaecef;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            font-size: 14px;
            border-bottom: 1px solid #2b3139;
            transition: 0.2s;
        }

        .dropdown-content a:last-child { border-bottom: none; }

        .dropdown-content a:hover {
            background-color: #2b3139;
            color: var(--primary-color);
            padding-left: 20px; /* ‡∏Ç‡∏¢‡∏±‡∏ö‡∏ô‡∏¥‡∏î‡∏ô‡∏∂‡∏á‡∏ï‡∏≠‡∏ô‡∏ä‡∏µ‡πâ */
        }

        /* ‡∏õ‡∏∏‡πà‡∏° Logout ‡∏™‡∏µ‡πÅ‡∏î‡∏á */
        .dropdown-content a.logout-item:hover {
            color: #f6465d;
            background-color: rgba(246, 70, 93, 0.1);
        }
    </style>
</head>
<body>

    <header class="header">
        <div class="header-left">
            <div class="logo">üåø ECOBANK</div>
            <nav class="nav">
                <a href="index.html" class="nav-link">‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</a>
                <a href="trash_types.html" class="nav-link">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏¢‡∏∞‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</a>
                <a href="leaderboard.html" class="nav-link">‡∏à‡∏±‡∏î‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</a>
                <a href="exchange.html" class="nav-link ">‡∏ï‡∏•‡∏≤‡∏î‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏¢</a>
                <a href="booths.html" class="nav-link">‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠</a>
                <a href="rewards.html" class="nav-link active">‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</a>
                <a href="wallet.html" class="nav-link">‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏á‡∏¥‡∏ô</a>
            </nav>
        </div>
        <div id="authSection" class="header-right"></div>
    </header>

    <main class="container animate-fade-in">
        <div class="page-title">üéÅ ‡πÅ‡∏•‡∏Å‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</div>
        <p class="page-subtitle">‡πÉ‡∏ä‡πâ‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏∞‡∏™‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏•‡∏Å‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏£‡∏±‡∏Å‡∏©‡πå‡πÇ‡∏•‡∏Å</p>

        <div class="points-banner">
            <div>
                <div class="points-label">‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏∞‡∏™‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</div>
                <div class="my-points" id="userPoints">...</div>
            </div>
            <div style="font-size: 40px;">ü™ô</div>
        </div>

        <div id="rewardsList" class="rewards-grid">
            <div style="text-align:center; grid-column: 1/-1; color:#666; padding: 40px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•...</div>
        </div>

        

    </main>

    <script type="module">
        import { 
            getRewards, getUserWallet, redeemReward, seedInitialData, showPopup, showConfirm 
        } from "./js/firebase-service.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { auth } from "./js/firebase-config.js";

        let currentUser = null;
        let userPoints = 0;

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Login ‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á Dropdown
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                
                // ‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á Dropdown HTML
                document.getElementById('authSection').innerHTML = `
                    <div class="user-dropdown">
                        <div class="user-btn">
                            <div class="user-avatar-xs">üë§</div>
                            <span>${user.email.split('@')[0]}</span>
                            <span style="font-size:10px; color:#888;">‚ñº</span>
                        </div>
                        <div class="dropdown-content">
                            <a href="profile.html">üë§ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß (Profile)</a>
                            <a href="wallet.html">üí∞ ‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏á‡∏¥‡∏ô (Wallet)</a>
                            <a href="#" id="logoutBtn" class="logout-item">üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</a>
                        </div>
                    </div>
                `;

                // ‡∏ú‡∏π‡∏Å‡∏õ‡∏∏‡πà‡∏° Logout ‡πÉ‡∏´‡∏°‡πà (‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏á‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡πÉ‡∏´‡∏°‡πà)
                document.getElementById('logoutBtn').addEventListener('click', async (e) => {
                    e.preventDefault();
                    if(await showConfirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô", "‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö?")) {
                        await signOut(auth);
                        window.location.href = 'login.html';
                    }
                });

                // ... (‡πÇ‡∏Ñ‡πâ‡∏î‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‡πÄ‡∏ä‡πà‡∏ô loadWalletData ‡∏´‡∏£‡∏∑‡∏≠ loadStats) ...
                if (typeof loadWalletData === 'function') await loadWalletData(); 
                if (typeof loadUserData === 'function') await loadUserData();

            } else {
                // ‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ Login
                document.getElementById('authSection').innerHTML = `<a href="login.html" class="btn btn-primary" style="padding: 8px 20px;">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</a>`;
                // ... (‡∏ã‡πà‡∏≠‡∏ô‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ï‡∏≤‡∏°‡πÄ‡∏î‡∏¥‡∏°) ...
            }
        });

        async function loadUserData() {
            if (!currentUser) return;
            const wallet = await getUserWallet(currentUser.uid);
            userPoints = wallet ? (wallet.points || 0) : 0;
            animateValue("userPoints", 0, userPoints, 1000);
            loadRewards(); // Reload rewards to check enabled/disabled buttons
        }

        async function loadRewards() {
            const container = document.getElementById('rewardsList');
            const rewards = await getRewards();

            if (rewards.length === 0) {
                container.innerHTML = '<div style="text-align:center; grid-column: 1/-1; color:#666;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</div>';
                return;
            }

            container.innerHTML = rewards.map(r => {
                const canRedeem = currentUser && userPoints >= r.cost;
                return `
                <div class="reward-card">
                    <div class="reward-icon">${r.icon}</div>
                    <div class="reward-name">${r.name}</div>
                    <div class="reward-desc">${r.desc}</div>
                    <div class="reward-cost">${r.cost} ‡πÅ‡∏ï‡πâ‡∏°</div>
                    <button class="btn-redeem" ${canRedeem ? '' : 'disabled'} 
                        onclick="triggerRedeem('${r.id}', '${r.name}', ${r.cost})">
                        ${canRedeem ? '‡πÅ‡∏•‡∏Å‡πÄ‡∏•‡∏¢' : '‡πÅ‡∏ï‡πâ‡∏°‡πÑ‡∏°‡πà‡∏û‡∏≠'}
                    </button>
                </div>`;
            }).join('');
        }

        window.triggerRedeem = async (id, name, cost) => {
            if (!currentUser) return showPopup("‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô", "error");
            
            if (await showConfirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏Å", `‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏Å "${name}" ‡πÉ‡∏ä‡πâ ${cost} ‡πÅ‡∏ï‡πâ‡∏°?`)) {
                const result = await redeemReward(currentUser.uid, { id, name, cost });
                
                if (result.success) {
                    await showPopup("‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "‡πÅ‡∏•‡∏Å‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!", "success");
                    loadUserData(); // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ï‡πâ‡∏°‡πÉ‡∏´‡∏°‡πà
                } else {
                    await showPopup("‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", result.message, "error");
                }
            }
        };

        // Admin Seed
        window.seedRewards = async () => {
            if(await showConfirm("Admin Only", "‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) {
                await seedInitialData();
                showPopup("‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢", "success");
                loadRewards();
            }
        };

        function animateValue(id, start, end, duration) {
            const obj = document.getElementById(id); if(!obj) return;
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                obj.innerHTML = Math.floor(progress * (end - start) + start).toLocaleString();
                if (progress < 1) window.requestAnimationFrame(step);
            };
            window.requestAnimationFrame(step);
        }
    </script>
</body>
</html>