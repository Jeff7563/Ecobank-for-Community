<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å - ECOBANK</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        /* CSS ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏´‡∏ô‡πâ‡∏≤ Home */
        .hero-section {
            text-align: center;
            padding: 40px 20px;
            margin-bottom: 20px;
        }
        .hero-title {
            font-size: 36px;
            font-weight: 800;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #fff, #bbb);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .hero-subtitle {
            color: #848e9c;
            font-size: 16px;
        }

        /* Stats Grid */
        .home-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-bottom: 50px;
        }

        .home-stat-card {
            background: #1e2329;
            border: 1px solid #2b3139;
            border-radius: 16px;
            padding: 30px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            transition: transform 0.3s;
        }
        .home-stat-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary-color);
        }

        .h-icon-box {
            width: 50px; height: 50px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            font-size: 24px; margin-bottom: 20px;
        }

        .h-label { font-size: 14px; color: #848e9c; margin-bottom: 5px; font-weight: 600; }
        .h-value { font-size: 28px; font-weight: 800; color: #eaecef; }
        .h-unit { font-size: 16px; color: #848e9c; font-weight: 400; margin-left: 5px; }
        .h-trend { font-size: 14px; margin-top: 5px; font-weight: 600; }
        .trend-up { color: var(--primary-color); }

        /* Table Section */
        .section-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px;
        }
        .table-card {
            background: #1e2329;
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid #2b3139;
        }
        .home-table {
            width: 100%; border-collapse: collapse;
        }
        .home-table th {
            text-align: left; padding: 20px;
            color: #848e9c; font-size: 13px; font-weight: 600;
            border-bottom: 1px solid #2b3139;
            background: #161a1e;
        }
        .home-table td {
            padding: 20px;
            border-bottom: 1px solid #2b3139;
            color: #eaecef; font-size: 15px;
        }
        .home-table tr:last-child td { border-bottom: none; }
        .home-table tr:hover { background: rgba(255,255,255,0.02); }

        .trash-icon-sm { margin-right: 10px; font-size: 18px; }
        .badge-cate {
            background: #2b3139; color: #aaa;
            padding: 4px 10px; border-radius: 6px; font-size: 11px;
            text-transform: uppercase; letter-spacing: 0.5px;
        }
        .text-price { color: var(--primary-color); font-weight: 700; }
        .text-volume { color: #fff; font-weight: 500; font-family: 'Courier New', Courier, monospace; }

        /* Dropdown Styles */
        .user-dropdown { position: relative; display: inline-block; }
        .user-btn { background: #1e2329; color: #eaecef; padding: 8px 16px; border-radius: 20px; border: 1px solid #2b3139; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: 0.3s; font-size: 14px; }
        .user-btn:hover { border-color: var(--primary-color); background: #2b3139; }
        .user-avatar-xs { width: 24px; height: 24px; background: var(--primary-color); color: #000; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; }
        .dropdown-content { display: none; position: absolute; right: 0; top: 100%; margin-top: 10px; background-color: #1e2329; min-width: 200px; box-shadow: 0 8px 24px rgba(0,0,0,0.5); border-radius: 12px; border: 1px solid #2b3139; z-index: 1000; overflow: visible; }
        .dropdown-content::before { content: ""; position: absolute; top: -20px; left: 0; width: 100%; height: 20px; background: transparent; }
        .user-dropdown:hover .dropdown-content { display: block; animation: fadeIn 0.2s; }
        .dropdown-content a { color: #eaecef; padding: 12px 16px; text-decoration: none; display: block; font-size: 14px; border-bottom: 1px solid #2b3139; transition: 0.2s; }
        .dropdown-content a:last-child { border-bottom: none; }
        .dropdown-content a:hover { background-color: #2b3139; color: var(--primary-color); padding-left: 20px; }
        .dropdown-content a.logout-item:hover { color: #f6465d; background-color: rgba(246, 70, 93, 0.1); }
    </style>
</head>
<body>

    <header class="header">
        <div class="header-left">
            <div class="logo">üåø ECOBANK</div>
            <nav class="nav">
                <a href="index.html" class="nav-link active">‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</a>
                <a href="trash_types.html" class="nav-link">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏¢‡∏∞‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</a>
                <a href="leaderboard.html" class="nav-link">‡∏à‡∏±‡∏î‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</a>
                <a href="exchange.html" class="nav-link">‡∏ï‡∏•‡∏≤‡∏î‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏¢</a>
                <a href="booths.html" class="nav-link">‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠</a>
                <a href="wallet.html" class="nav-link">‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏á‡∏¥‡∏ô</a>
            </nav>
        </div>
        <div id="authSection" class="header-right"></div>
    </header>

    <main class="container animate-fade-in">
        
        <div class="hero-section">
            <div class="hero-title">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ç‡∏¢‡∏∞‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤ ‚ôªÔ∏è</div>
            <p class="hero-subtitle">‡πÄ‡∏ä‡πá‡∏Ñ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏¢‡∏∞‡πÅ‡∏ö‡∏ö Real-time ‡πÅ‡∏•‡∏∞‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ä‡∏∏‡∏°‡∏ä‡∏ô</p>
        </div>

        <div class="home-stats-grid">
            
            <div class="home-stat-card">
                <div class="h-icon-box">üìà</div>
                <div class="h-label">‡∏î‡∏±‡∏ä‡∏ô‡∏µ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏¢‡∏∞</div>
                <div class="h-value" style="font-size:24px;">Stable</div>
                <div class="h-trend trend-up">+2.4% <span style="color:#848e9c; font-weight:400; font-size:12px;">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</span></div>
            </div>

            <div class="home-stat-card">
                <div class="h-icon-box" style="color:var(--primary-color);">‚öñÔ∏è</div>
                <div class="h-label">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠‡∏£‡∏ß‡∏°</div>
                <div>
                    <span class="h-value" id="homeTotalWeight">0</span>
                    <span class="h-unit">kg</span>
                </div>
            </div>

            <div class="home-stat-card">
                <div class="h-icon-box" style="color:#a855f7;">üë•</div>
                <div class="h-label">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ä‡∏∏‡∏°‡∏ä‡∏ô</div>
                <div>
                    <span class="h-value" id="homeTotalMembers">0</span>
                    <span class="h-unit">‡∏Ñ‡∏ô</span>
                </div>
            </div>

        </div>

        <div class="section-header">
            <h3>üî• ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏¢‡∏∞‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏° (Top Movers)</h3>
            <a href="trash_types.html" class="btn btn-outline" style="font-size:12px; padding:6px 12px;">‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ></a>
        </div>

        <div class="table-card">
            <table class="home-table">
                <thead>
                    <tr>
                        <th>‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏¢‡∏∞</th>
                        <th>‡∏£‡∏≤‡∏Ñ‡∏≤ / KG</th>
                        <th>‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏¢ (Volume)</th>
                        <th>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</th>
                    </tr>
                </thead>
                <tbody id="homeTrashTable">
                    <tr><td colspan="4" style="text-align:center; color:#666;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr>
                </tbody>
            </table>
        </div>

    </main>

    <script type="module">
        import { getCommunityStats, getTrashTypes, getTrashVolumeStats, showConfirm } from "./js/firebase-service.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { auth } from "./js/firebase-config.js";

        // Auth Logic & Dropdown
        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('authSection').innerHTML = `
                    <div class="user-dropdown">
                        <div class="user-btn"><div class="user-avatar-xs">üë§</div><span>${user.email.split('@')[0]}</span><span style="font-size:10px; color:#888;">‚ñº</span></div>
                        <div class="dropdown-content">
                            <a href="profile.html">üë§ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß (Profile)</a><a href="wallet.html">üí∞ ‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏á‡∏¥‡∏ô (Wallet)</a><a href="#" id="logoutBtn" class="logout-item">üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</a>
                        </div>
                    </div>`;
                document.getElementById('logoutBtn').addEventListener('click', async (e) => { e.preventDefault(); if(await showConfirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô","‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö?")) { await signOut(auth); window.location.href='login.html'; } });
            } else {
                document.getElementById('authSection').innerHTML = `<a href="login.html" class="btn btn-login">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</a><a href="register.html" class="btn btn-register">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</a>`;
            }
        });

        // Main Logic
        async function initHome() {
            try {
                // 1. ‡∏î‡∏∂‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°
                const stats = await getCommunityStats('all');
                animateValue("homeTotalWeight", 0, parseFloat(stats.weight), 1500);
                animateValue("homeTotalMembers", 0, stats.members, 1500);

                // 2. ‡∏î‡∏∂‡∏á‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á (Volume) ‡∏°‡∏≤‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ
                const volumeStats = await getTrashVolumeStats();

                // 3. ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏¢‡∏∞‡∏°‡∏≤‡πÇ‡∏ä‡∏ß‡πå
                const trashList = await getTrashTypes();
                const tbody = document.getElementById('homeTrashTable');
                
                // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏°‡∏≤‡πÇ‡∏ä‡∏ß‡πå‡πÅ‡∏Ñ‡πà 5 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡πÅ‡∏£‡∏Å
                const top5 = trashList.slice(0, 5); 

                if (top5.length > 0) {
                    tbody.innerHTML = top5.map(t => {
                        // ‚úÖ ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏≤‡∏Å DB (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô 0)
                        const volume = volumeStats[t.id] || 0;

                        return `
                        <tr>
                            <td><span class="trash-icon-sm">${t.icon || 'üì¶'}</span> ${t.name}</td>
                            <td class="text-price">‡∏ø${t.price_per_unit}</td>
                            <td class="text-volume">${volume.toLocaleString()} kg</td>
                            <td><span class="badge-cate">${t.category}</span></td>
                        </tr>`;
                    }).join('');
                } else {
                    tbody.innerHTML = `<tr><td colspan="4" style="text-align:center;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`;
                }
            } catch (err) {
                console.error("Home Init Error:", err);
            }
        }

        function animateValue(id, start, end, duration) {
            const obj = document.getElementById(id); if(!obj) return;
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                obj.innerHTML = parseFloat(progress * (end - start) + start).toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 2});
                if (progress < 1) window.requestAnimationFrame(step);
            };
            window.requestAnimationFrame(step);
        }

        initHome();
    </script>
</body>
</html>