<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏¢‡∏∞‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ - ECOBANK</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        /* --- User Dropdown Style (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà) --- */
        .user-dropdown {
            position: relative;
            display: inline-block;
        }

        .user-btn {
            background: #1e2329;
            color: #eaecef;
            padding: 8px 16px;
            border-radius: 20px;
            border: 1px solid #2b3139;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: 0.3s;
            font-size: 14px;
        }

        .user-btn:hover {
            border-color: var(--primary-color);
            background: #2b3139;
        }

        .user-avatar-xs {
            width: 24px; height: 24px;
            background: var(--primary-color);
            color: #000;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 14px;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            top: 100%; 
            margin-top: 10px; 
            background-color: #1e2329;
            min-width: 200px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.5);
            border-radius: 12px;
            border: 1px solid #2b3139;
            z-index: 1000;
            overflow: visible;
        }

        .dropdown-content::before {
            content: "";
            position: absolute;
            top: -20px;
            left: 0;
            width: 100%;
            height: 20px;
            background: transparent;
        }

        .user-dropdown:hover .dropdown-content {
            display: block;
            animation: fadeIn 0.2s;
        }

        .dropdown-content a {
            color: #eaecef;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            font-size: 14px;
            border-bottom: 1px solid #2b3139;
            transition: 0.2s;
        }

        .dropdown-content a:last-child { border-bottom: none; }

        .dropdown-content a:hover {
            background-color: #2b3139;
            color: var(--primary-color);
            padding-left: 20px;
        }

        .dropdown-content a.logout-item:hover {
            color: #f6465d;
            background-color: rgba(246, 70, 93, 0.1);
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-left">
            <div class="logo">üåø ECOBANK</div>
            <nav class="nav">
                <a href="index.html" class="nav-link">‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</a>
                <a href="trash_types.html" class="nav-link active">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏¢‡∏∞‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</a>
                <a href="leaderboard.html" class="nav-link">‡∏à‡∏±‡∏î‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</a>
                <a href="exchange.html" class="nav-link">‡∏ï‡∏•‡∏≤‡∏î‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏¢</a>
                <a href="booths.html" class="nav-link">‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠</a>
                <a href="rewards.html" class="nav-link">‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</a>
                <a href="wallet.html" class="nav-link">‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏á‡∏¥‡∏ô</a>
            </nav>
        </div>
        <div id="authSection" class="header-right">
            <a href="login.html" class="btn btn-login">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</a>
            <a href="register.html" class="btn btn-register">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</a>
        </div>
    </header>

    <main class="container animate-fade-in">
        <div class="page-title">üì¶ ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏¢‡∏∞</div>
        <p class="page-subtitle">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏Ñ‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô (‡∏£‡∏≤‡∏Ñ‡∏≤‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠)</p>

        <div class="search-container">
            <span style="font-size: 20px; padding: 8px;">üîç</span>
            <input type="text" id="searchInput" class="search-input" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏¢‡∏∞ (‡πÄ‡∏ä‡πà‡∏ô ‡∏Ç‡∏ß‡∏î, ‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©)...">
        </div>

        <div class="filter-pills" style="margin-bottom: 30px;">
            <button class="filter-btn active" onclick="filterCategory('all')">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
            <button class="filter-btn" onclick="filterCategory('‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å')">‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å</button>
            <button class="filter-btn" onclick="filterCategory('‡πÇ‡∏•‡∏´‡∏∞')">‡πÇ‡∏•‡∏´‡∏∞</button>
            <button class="filter-btn" onclick="filterCategory('‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©')">‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©</button>
            <button class="filter-btn" onclick="filterCategory('‡πÅ‡∏Å‡πâ‡∏ß')">‡πÅ‡∏Å‡πâ‡∏ß</button>
        </div>

        <div id="trashGrid" class="grid-cards animate-slide-up">
            <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: var(--text-muted);">
                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•... ‚è≥
            </div>
        </div>
    </main>

    <script type="module">
        import { getTrashTypes } from "./js/firebase-service.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { auth } from "./js/firebase-config.js";

        let allTrashData = []; // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö

        // 1. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Auth Header
        const authSection = document.getElementById('authSection');
        onAuthStateChanged(auth, (user) => {
            if (user) {
                authSection.innerHTML = `
                    <div class="user-dropdown">
                        <div class="user-btn">
                            <div class="user-avatar-xs">üë§</div>
                            <span>${user.email.split('@')[0]}</span>
                            <span style="font-size:10px; color:#888;">‚ñº</span>
                        </div>
                        <div class="dropdown-content">
                            <a href="profile.html">üë§ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß (Profile)</a>
                            <a href="wallet.html">üí∞ ‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏á‡∏¥‡∏ô (Wallet)</a>
                            <a href="#" id="logoutBtn" class="logout-item">üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</a>
                        </div>
                    </div>
                `;
                document.getElementById('logoutBtn').addEventListener('click', async (e) => {
                    e.preventDefault();
                    await signOut(auth);
                    window.location.href = 'login.html';
                });
            }
        });

        // 2. ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
        async function initPage() {
            try {
                allTrashData = await getTrashTypes();
                renderGrid(allTrashData); // ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏£‡∏≠‡∏ö‡πÅ‡∏£‡∏Å
            } catch (error) {
                document.getElementById('trashGrid').innerHTML = `<p style="color:red; text-align:center;">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}</p>`;
            }
        }

        // 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ß‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡πå‡∏î
        function renderGrid(data) {
            const grid = document.getElementById('trashGrid');
            
            if (data.length === 0) {
                grid.innerHTML = `<p style="grid-column: 1/-1; text-align: center; color: var(--text-muted);">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</p>`;
                return;
            }

            grid.innerHTML = data.map(item => `
                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:start;">
                        <div class="card-icon">${item.icon || 'üì¶'}</div>
                        <span style="font-size:12px; background:#2b3139; padding:4px 8px; border-radius:4px; color:var(--text-muted);">${item.category}</span>
                    </div>
                    <div class="card-title" style="margin-top:10px;">${item.name}</div>
                    <div style="display:flex; justify-content:space-between; align-items:end; margin-top:15px;">
                        <div>
                            <div style="font-size:12px; color:var(--text-muted);">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠</div>
                            <div class="card-value">‡∏ø${item.price_per_unit.toFixed(2)}</div>
                        </div>
                        <div style="font-size:12px; color:var(--text-muted);">‡∏ï‡πà‡∏≠ ${item.unit}</div>
                    </div>
                </div>
            `).join('');
        }

        // 4. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Search & Filter)
        window.filterCategory = (category) => {
            // ‡∏õ‡∏£‡∏±‡∏ö Active Class ‡∏õ‡∏∏‡πà‡∏°
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            const searchVal = document.getElementById('searchInput').value.toLowerCase();
            let filtered = allTrashData.filter(item => 
                (item.name.toLowerCase().includes(searchVal)) &&
                (category === 'all' || item.category === category)
            );
            renderGrid(filtered);
        }

        // Event Listener ‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
        document.getElementById('searchInput').addEventListener('keyup', (e) => {
            const activeBtn = document.querySelector('.filter-btn.active');
            // ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà
            activeBtn.click();
        });

        initPage();
    </script>
</body>
</html>