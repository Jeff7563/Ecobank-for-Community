<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏á‡∏¥‡∏ô - ECOBANK</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .wallet-card {
            background: linear-gradient(135deg, #1e2329 0%, #15181d 100%);
            border: 1px solid #2b3139; border-radius: 20px; padding: 40px;
            text-align: center; margin-bottom: 30px; position: relative; overflow: hidden;
        }
        .wallet-card::before {
            content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle, rgba(178,255,89,0.05) 0%, rgba(0,0,0,0) 70%); pointer-events: none;
        }
        .balance-title { color: var(--text-muted); font-size: 16px; margin-bottom: 10px; }
        .balance-amount { font-size: 56px; font-weight: 800; color: var(--primary-color); letter-spacing: -1px; }
        .balance-unit { font-size: 20px; color: var(--text-main); font-weight: normal; margin-left: 10px; }
        
        /* ‡∏õ‡∏∏‡πà‡∏° Action */
        .action-container { display: flex; justify-content: center; margin-bottom: 40px; }
        .btn-withdraw {
            background: transparent;
            border: 1px solid #f6465d;
            color: #f6465d;
            padding: 12px 30px;
            border-radius: 30px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
            display: flex; align-items: center; gap: 8px;
        }
        .btn-withdraw:hover { background: #f6465d; color: #fff; box-shadow: 0 0 15px rgba(246, 70, 93, 0.4); }

        .tx-item { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 15px 20px; border-bottom: 1px solid #2b3139; transition: 0.2s; 
            cursor: pointer; border-radius: 8px;
        }
        .tx-item:hover { background: #2b3139; transform: translateX(5px); }
        .tx-icon { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; margin-right: 15px; }
        
        .content-tabs { display: flex; gap: 30px; margin: 30px 0 20px 0; border-bottom: 1px solid #2b3139; }
        .content-tab { padding: 10px 0; color: #848e9c; cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.2s; }
        .content-tab.active { color: #eaecef; border-bottom-color: var(--primary-color); }
        
        .portfolio-item { 
            background: #1e2329; border: 1px solid #2b3139; border-radius: 12px; padding: 15px; 
            display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; 
        }

        /* --- Modal Withdraw --- */
        .modal-input {
            width: 100%; padding: 12px; background: #0b0e11; border: 1px solid #2b3139;
            color: #fff; font-size: 24px; text-align: center; border-radius: 8px; margin: 20px 0;
        }
        .modal-input:focus { border-color: var(--primary-color); outline: none; }

        /* --- Receipt & Dropdown Styles --- */
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.85); backdrop-filter: blur(8px); align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s; }
        .modal.show { display: flex; opacity: 1; }
        .receipt-paper { background: #fff; color: #000; width: 320px; padding: 30px; border-radius: 0; position: relative; box-shadow: 0 0 50px rgba(0,0,0,0.5); font-family: 'Courier New', Courier, monospace; transform: scale(0.9); transition: transform 0.3s; background-image: radial-gradient(#eee 1px, transparent 1px); background-size: 10px 10px; }
        .modal.show .receipt-paper { transform: scale(1); }
        .receipt-paper::after { content: ""; position: absolute; bottom: -10px; left: 0; width: 100%; height: 10px; background: linear-gradient(45deg, transparent 33.333%, #fff 33.333%, #fff 66.667%, transparent 66.667%), linear-gradient(-45deg, transparent 33.333%, #fff 33.333%, #fff 66.667%, transparent 66.667%); background-size: 20px 20px; }
        .receipt-header { text-align: center; border-bottom: 2px dashed #000; padding-bottom: 15px; margin-bottom: 15px; }
        .receipt-logo { font-size: 24px; font-weight: bold; }
        .receipt-meta { font-size: 12px; color: #333; margin-top: 5px; }
        .receipt-table { width: 100%; font-size: 12px; margin-bottom: 15px; }
        .receipt-table th { text-align: left; border-bottom: 1px solid #000; padding: 5px 0; }
        .receipt-table td { padding: 5px 0; vertical-align: top; }
        .receipt-total { border-top: 2px dashed #000; padding-top: 10px; text-align: right; font-size: 18px; font-weight: bold; margin-bottom: 20px; }
        .receipt-footer { text-align: center; font-size: 10px; color: #555; }
        .close-receipt { position: absolute; top: -40px; right: 0; color: #fff; font-size: 30px; cursor: pointer; }

        /* User Dropdown */
        .user-dropdown { position: relative; display: inline-block; }
        .user-btn { background: #1e2329; color: #eaecef; padding: 8px 16px; border-radius: 20px; border: 1px solid #2b3139; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: 0.3s; font-size: 14px; }
        .user-btn:hover { border-color: var(--primary-color); background: #2b3139; }
        .user-avatar-xs { width: 24px; height: 24px; background: var(--primary-color); color: #000; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; }
        
        .dropdown-content { 
            display: none; position: absolute; right: 0; top: 100%; margin-top: 10px; 
            background-color: #1e2329; min-width: 200px; box-shadow: 0 8px 24px rgba(0,0,0,0.5); 
            border-radius: 12px; border: 1px solid #2b3139; z-index: 1000; overflow: visible; 
        }
        .dropdown-content::before { content: ""; position: absolute; top: -20px; left: 0; width: 100%; height: 20px; background: transparent; }
        .user-dropdown:hover .dropdown-content { display: block; animation: fadeIn 0.2s; }
        
        .dropdown-content a { color: #eaecef; padding: 12px 16px; text-decoration: none; display: block; font-size: 14px; border-bottom: 1px solid #2b3139; transition: 0.2s; }
        .dropdown-content a:last-child { border-bottom: none; }
        .dropdown-content a:hover { background-color: #2b3139; color: var(--primary-color); padding-left: 20px; }
        .dropdown-content a.logout-item:hover { color: #f6465d; background-color: rgba(246, 70, 93, 0.1); }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-left"><div class="logo">üåø ECOBANK</div><nav class="nav"><a href="index.html" class="nav-link">‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</a><a href="trash_types.html" class="nav-link">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏¢‡∏∞‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</a><a href="leaderboard.html" class="nav-link">‡∏à‡∏±‡∏î‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</a><a href="exchange.html" class="nav-link">‡∏ï‡∏•‡∏≤‡∏î‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏¢</a><a href="booths.html" class="nav-link">‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠</a><a href="rewards.html" class="nav-link">‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</a><a href="wallet.html" class="nav-link active">‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏á‡∏¥‡∏ô</a></nav></div>
        <div id="authSection" class="header-right"></div>
    </header>

    <main class="container animate-fade-in">
        <div class="page-title">üí∞ My Wallet</div>
        <div id="walletContent" style="display:none;">
            <div class="wallet-card animate-slide-up">
                <div class="balance-title">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÉ‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</div>
                <div class="balance-amount"><span id="balanceText">0.00</span><span class="balance-unit">THB</span></div>
                <div style="margin-top: 20px; font-size: 14px; color: var(--text-muted);">User ID: <span id="userIdDisplay">...</span></div>
            </div>

            <div class="action-container">
                <button onclick="openWithdrawModal()" class="btn-withdraw">
                    üè¶ ‡πÅ‡∏à‡πâ‡∏á‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (Withdraw)
                </button>
            </div>

            <div class="content-tabs">
                <div class="content-tab active" onclick="switchTab('portfolio')">‡∏û‡∏≠‡∏£‡πå‡∏ï‡πÇ‡∏ü‡∏•‡∏¥‡πÇ‡∏≠‡∏Ç‡∏¢‡∏∞</div>
                <div class="content-tab" onclick="switchTab('history')">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
            </div>

            <div id="portfolioTab"><div id="portfolioGrid">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div></div>
            <div id="historyTab" style="display: none;">
                <div style="margin-bottom:10px; font-size:12px; color:#666; text-align:right;">* ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</div>
                <div id="transactionList" class="table-container">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
            </div>
        </div>

        <div id="loginWarning" style="display:none; text-align: center; padding: 60px; background: var(--bg-card); border-radius: 12px;">
            <div style="font-size: 50px; margin-bottom: 20px;">üîí</div>
            <h2>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h2>
            <a href="login.html" class="btn btn-primary">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</a>
        </div>
    </main>

    <div class="modal" id="withdrawModal">
        <div style="background:#1e2329; padding:30px; border-radius:16px; border:1px solid #2b3139; width:90%; max-width:400px; text-align:center;">
            <h3 style="color:#fff; margin-bottom:10px;">üí∏ ‡πÅ‡∏à‡πâ‡∏á‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</h3>
            <p style="color:#888; font-size:14px;">‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ñ‡∏≠‡∏ô</p>
            <input type="number" id="withdrawAmount" class="modal-input" placeholder="0.00" step="10">
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button onclick="closeWithdrawModal()" class="btn" style="flex:1; background:#2b3139; color:#fff; border:none; padding:12px; border-radius:8px;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button onclick="confirmWithdraw()" class="btn btn-primary" style="flex:1; padding:12px; border-radius:8px;">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
            </div>
        </div>
    </div>

    <div class="modal" id="receiptModal">
        <div style="position:relative;">
            <span class="close-receipt" onclick="closeReceipt()">&times;</span>
            <div class="receipt-paper">
                <div class="receipt-header">
                    <div class="receipt-logo">üåø ECOBANK</div>
                    <div class="receipt-meta">RECEIPT / Tax Invoice</div>
                    <div class="receipt-meta" id="rcpDate">Date: -</div>
                    <div class="receipt-meta" id="rcpId">ID: -</div>
                </div>
                <table class="receipt-table">
                    <thead><tr><th>Item</th><th style="text-align:right;">Total</th></tr></thead>
                    <tbody id="rcpItems"></tbody>
                </table>
                <div class="receipt-total" id="rcpTotal">Total: 0.00 THB</div>
                <div class="receipt-footer">Thank you for saving the world!<br>www.ecobank.com<div style="margin-top:10px; font-size:24px;">üå±</div></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { 
            getUserWallet, getUserTransactions, getTrashTypes, getTrashTypeById, requestWithdraw, 
            showPopup, showConfirm 
        } from "./js/firebase-service.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { auth } from "./js/firebase-config.js";

        let currentUser = null;
        let globalTransactions = [];
        let allTrashTypes = []; 

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                // Render Dropdown
                document.getElementById('authSection').innerHTML = `
                    <div class="user-dropdown">
                        <div class="user-btn"><div class="user-avatar-xs">üë§</div><span>${user.email.split('@')[0]}</span><span style="font-size:10px; color:#888;">‚ñº</span></div>
                        <div class="dropdown-content">
                            <a href="profile.html">üë§ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß (Profile)</a><a href="wallet.html">üí∞ ‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏á‡∏¥‡∏ô (Wallet)</a><a href="#" id="logoutBtn" class="logout-item">üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</a>
                        </div>
                    </div>`;
                document.getElementById('logoutBtn').addEventListener('click', async (e) => { e.preventDefault(); if(await showConfirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô","‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö?")) { await signOut(auth); window.location.href='login.html'; } });
                
                document.getElementById('walletContent').style.display = 'block';
                document.getElementById('loginWarning').style.display = 'none';
                document.getElementById('userIdDisplay').innerText = user.uid.slice(0, 8) + "...";
                
                // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏¢‡∏∞‡∏°‡∏≤‡∏£‡∏≠‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô
                allTrashTypes = await getTrashTypes();
                await loadWalletData();
            } else {
                document.getElementById('authSection').innerHTML = `<a href="login.html" class="btn btn-login">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</a>`;
                document.getElementById('walletContent').style.display = 'none';
                document.getElementById('loginWarning').style.display = 'block';
            }
        });

        window.switchTab = (tabName) => {
            document.querySelectorAll('.content-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('portfolioTab').style.display = tabName === 'portfolio' ? 'block' : 'none';
            document.getElementById('historyTab').style.display = tabName === 'history' ? 'block' : 'none';
        }

        async function loadWalletData() {
            if (!currentUser) return;
            const walletData = await getUserWallet(currentUser.uid);
            let balance = walletData?.balance?.cash || 0;
            animateValue("balanceText", 0, balance, 1000);

            // ‚úÖ Portfolio Logic (‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ Unknown Trash)
            const portfolio = walletData?.portfolio || {};
            const pContainer = document.getElementById('portfolioGrid');
            if (Object.keys(portfolio).length === 0) pContainer.innerHTML = '<div style="text-align:center; padding:20px; color:#888;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡∏¢‡∏∞‡πÉ‡∏ô‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏≠‡∏á</div>';
            else {
                let pHtml = '';
                for (const [id, qty] of Object.entries(portfolio)) {
                    // 1. ‡∏•‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏≤‡∏Å List ‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏•‡∏î‡∏°‡∏≤
                    let trash = allTrashTypes.find(t => t.id === id);
                    
                    // 2. ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ (‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏õ‡πá‡∏ô ID ‡πÄ‡∏Å‡πà‡∏≤) ‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å DB ‡∏ï‡∏£‡∏á‡πÜ
                    if (!trash) {
                        try {
                            trash = await getTrashTypeById(id);
                        } catch (e) { console.log("Not found in DB either"); }
                    }

                    // 3. ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡∏≠‡∏µ‡∏Å ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏£‡∏¥‡∏á‡πÜ
                    const name = trash ? trash.name : `<span style="color:#666;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏° (ID: ${id.slice(0,4)}...)</span>`;
                    const icon = trash ? (trash.icon || 'üì¶') : '‚ùì';
                    
                    pHtml += `<div class="portfolio-item"><div style="display:flex; align-items:center; gap:10px;"><span style="font-size:24px;">${icon}</span><div>${name}</div></div><div style="font-weight:bold; color:var(--primary-color);">${parseFloat(qty).toFixed(2)} kg</div></div>`;
                }
                pContainer.innerHTML = pHtml;
            }

            // Transactions
            globalTransactions = await getUserTransactions(currentUser.uid);
            const txContainer = document.getElementById('transactionList');
            if (globalTransactions.length === 0) txContainer.innerHTML = `<div style="padding: 30px; text-align: center; color: var(--text-muted);">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß</div>`;
            else {
                txContainer.innerHTML = globalTransactions.map((tx, index) => {
                    let dateStr = tx.created_at?.seconds ? new Date(tx.created_at.seconds * 1000).toLocaleString('th-TH') : "‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà";
                    const isIncome = (tx.type === 'deposit' || tx.type === 'sell');
                    const label = tx.type === 'sell' ? '‡∏Ç‡∏≤‡∏¢‡∏Ç‡∏¢‡∏∞' : (tx.type === 'withdraw' ? '‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô' : (tx.type === 'redeem' ? '‡πÅ‡∏•‡∏Å‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•' : tx.type));
                    const sign = isIncome ? '+' : '';
                    const colorClass = isIncome ? 'text-up' : 'text-down'; 
                    
                    return `
                    <div class="tx-item" onclick="openReceipt(${index})">
                        <div style="display:flex; align-items:center;">
                            <div class="tx-icon" style="background: #2b3139;">${isIncome?'üí∞':'üí∏'}</div>
                            <div>
                                <div style="font-weight:600; color:var(--text-main);">${label}</div>
                                <div style="font-size:12px; color:var(--text-muted);">${dateStr}</div>
                            </div>
                        </div>
                        <div class="${colorClass}" style="font-weight:bold; font-size:16px;">
                            ${sign}${Math.abs(tx.amount).toFixed(2)} ${tx.type==='redeem'?'‡πÅ‡∏ï‡πâ‡∏°':'‡∏ø'}
                        </div>
                    </div>`;
                }).join('');
            }
        }

        // --- Withdraw Logic ---
        window.openWithdrawModal = () => { document.getElementById('withdrawModal').classList.add('show'); };
        window.closeWithdrawModal = () => { document.getElementById('withdrawModal').classList.remove('show'); };
        
        window.confirmWithdraw = async () => {
            const amount = parseFloat(document.getElementById('withdrawAmount').value);
            if(!amount || amount <= 0) return showPopup("‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô", "error");
            
            if(await showConfirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô", `‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô ${amount} ‡∏ö‡∏≤‡∏ó?`)) {
                const res = await requestWithdraw(currentUser.uid, amount);
                if(res.success) {
                    await showPopup("‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "‡πÅ‡∏à‡πâ‡∏á‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß", "success");
                    closeWithdrawModal();
                    loadWalletData();
                } else {
                    showPopup("‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", res.message, "error");
                }
            }
        };

        // --- Receipt Logic ---
        window.openReceipt = (index) => {
            const tx = globalTransactions[index];
            if(!tx) return;
            document.getElementById('rcpDate').innerText = `Date: ${tx.created_at?.seconds ? new Date(tx.created_at.seconds * 1000).toLocaleString('th-TH') : "N/A"}`;
            document.getElementById('rcpId').innerText = `Ref: ${tx.id.slice(0,8).toUpperCase()}`;
            document.getElementById('rcpTotal').innerText = `Total: ${Math.abs(tx.amount).toFixed(2)} ${tx.type==='redeem'?'Points':'THB'}`;

            let itemsHtml = '';
            if (tx.type === 'sell' && tx.items && Array.isArray(tx.items)) {
                tx.items.forEach(item => {
                    itemsHtml += `<tr><td>${item.name}<br><span style="color:#666;">${item.weight}kg x ${item.price}</span></td><td style="text-align:right;">${item.subtotal.toFixed(2)}</td></tr>`;
                });
            } else {
                const label = tx.detail || (tx.type === 'withdraw' ? 'Withdrawal' : 'Transaction');
                itemsHtml = `<tr><td>${label}</td><td style="text-align:right;">${Math.abs(tx.amount).toFixed(2)}</td></tr>`;
            }
            document.getElementById('rcpItems').innerHTML = itemsHtml;
            document.getElementById('receiptModal').classList.add('show');
        };
        window.closeReceipt = () => document.getElementById('receiptModal').classList.remove('show');

        function animateValue(id, start, end, duration) {
            const obj = document.getElementById(id); if(!obj) return;
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                obj.innerHTML = (progress * (end - start) + start).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
                if (progress < 1) window.requestAnimationFrame(step);
            };
            window.requestAnimationFrame(step);
        }
    </script>
</body>
</html>